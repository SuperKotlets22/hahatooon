# –≠—Ç–∞–ø 1: –°–±–æ—Ä–∫–∞ (Builder)
FROM golang:1.23-alpine AS builder

# üö® –í–ê–ñ–ù–û: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º GCC –∏ Musl (–Ω—É–∂–Ω—ã –¥–ª—è SQLite)
RUN apk add --no-cache gcc musl-dev

WORKDIR /app

# –°–∫–∞—á–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
COPY go.mod go.sum ./
RUN go mod download

# –ö–æ–ø–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
COPY . .

# –°–æ–±–∏—Ä–∞–µ–º –±–∏–Ω–∞—Ä–Ω–∏–∫ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π CGO (SQLite)
ENV CGO_ENABLED=1
RUN go build -v -x -o t-queue-server .

# –≠—Ç–∞–ø 2: –§–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ (Runner)
FROM alpine:latest

WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —ç—Ç–∞–ø–∞
COPY --from=builder /app/t-queue-server .

# üö® –í–ê–ñ–ù–û: –ö–æ–ø–∏—Ä—É–µ–º –ø–∞–ø–∫—É static (HTML/CSS/JS)
COPY --from=builder /app/static ./static

# –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç
EXPOSE 8080

# –ó–∞–ø—É—Å–∫–∞–µ–º
CMD ["./t-queue-server"]
